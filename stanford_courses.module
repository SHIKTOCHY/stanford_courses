<?php

include_once('stanford_courses.features.inc');

/*
 * Implementation of hook_help().
 */
function stanford_courses_help($path, $arg) {
  switch ($path) {
    case 'admin/help#stanford_courses':
      $output = '<p>'. t('This module provides a turnkey solution for importing course information from !explorecourses. It includes a &quot;Stanford Course&quot; content type, a &quot;Stanford Course Section&quot; content type, a feed importer for each content type, and Views of all courses and course sections. ', array('!explorecourses' => l('explorecourses.stanford.edu', 'http://explorecourses.stanford.edu'))) .'</p>';
      $output .= '<p>'. t('To import from a feed, first construct the search for the courses that you want to import at explorecourses.stanford.edu. Then, to retrieve the XML feed for the search, change <strong>view=catalog</strong> to <strong>view=xml-20111011</strong> (current as of October, 2011) in the URL.') .'</p>';
      $output .= '<p>'. t('Paste the XML feed URL into the URL box at !import and click the <strong>Import</strong> button to import <em>course</em> information.', array('!import' => l('import/stanford_course_importer', 'import/stanford_course_importer'))) .'</p>';
      $output .= '<p>'. t('Be sure to use the <strong>http</strong> prefix for the URL, as <strong>https</strong> will trigger an error.') .'</p>';
      $output .= '<p>'. t('Paste the <em>same</em> XML feed URL into the URL box at !import and click the <strong>Import</strong> button to import <em>course section</em> information.', array('!import' => l('import/stanford_course_section_importer', 'import/stanford_course_section_importer'))) .'</p>';
      $output .= '<p>'. t('<strong>Courses</strong> and <strong>Course Sections</strong> can have !nodereference relationships. ', array('!nodereference' => l('CCK Nodereference', 'https://drupal.org/project/cck')));
      $output .= t('These nodereferences get created &quot;automagically&quot; on import, based on a common <strong>Course ID</strong> value.') .'</p>';
      return $output;
  }
}

/*
 * Create nodereferences for Stanford Course and Stanford Course Section nodes.
 * Join on common Course ID fields.
 */
function stanford_courses_create_nodereference_submit($form, &$form_state) {
  $section_cid = 'field_stanford_section_course_id_value';
  $course_cid = 'field_stanford_course_course_id_value';
  $section_nid = 'field_stanford_section_course_nid';
  $course_nid = 'content_type_stanford_course.nid';
  $course_nid_rev = 'content_field_stanford_course_section.nid';
  $result = db_query("UPDATE {content_type_stanford_section} LEFT JOIN {content_type_stanford_course} ON %s = %s SET %s = %s", $section_cid, $course_cid, $section_nid, $course_nid);
  $course_nid_a = 'content_field_stanford_course_section.nid';
  $course_section_nid = 'field_stanford_course_section_nid';
  $section_nid_a = 'content_type_stanford_section.nid';
  $result = db_query("UPDATE {content_field_stanford_course_section} LEFT JOIN {content_type_stanford_course} ON %s = %s LEFT JOIN {content_type_stanford_section} ON %s = %s SET %s = %s WHERE %s = %s", $course_nid_a, $course_nid, $course_cid, $section_cid, $course_section_nid, $section_nid_a, $course_nid_a, $course_nid);
  cache_clear_all();
  drupal_set_message(t('If applicable, nodereferences between Stanford Course nodes and Stanford Course Section nodes have been created or updated.'));
}

/*
 * Retrieve all nodereference fields.
 */
function stanford_courses_get_nodereference_fields() {
  $type = 'nodereference';
  $results = db_query('SELECT * FROM {content_node_field} WHERE type = \'%s\'', $type);
  $nodereference_fields = array();
  while ($row = db_fetch_array($results)) {
    $nodereference_fields[] = $row['field_name'];
  }
  return $nodereference_fields;
}

/*
* Add the creation of noderferences at the time of import.
*/
function stanford_courses_form_feeds_import_form_alter(&$form, &$form_state) {
  if (($form['#importer_id'] == 'stanford_course_importer') || ($form['#importer_id'] == 'stanford_course_section_importer')) {
    $form['#submit'][] = 'stanford_courses_create_nodereference_submit';
  }
}
